import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import pytz
import json
import os
import base64
from io import BytesIO
import qrcode
import io
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import calendar
from plyer import notification

# Default settings
DEFAULT_SETTINGS = {
    "notification_enabled": True,
    "low_stock_threshold": 10,
    "reminder_advance_minutes": 5,
    "email_settings": {
        "enabled": False,
        "email": "",
        "password": ""
    },
    "reminder_settings": {
        "advance_reminder": 15,
        "remind_until_taken": True
    }
}

# Configuration
TIMEZONE = pytz.timezone('Asia/Kolkata')
DATA_DIR = "data"
DATA_FILE = os.path.join(DATA_DIR, "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç.csv")
HISTORY_FILE = os.path.join(DATA_DIR, "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ_‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ.csv")
REMINDER_LOG_FILE = os.path.join(DATA_DIR, "reminder_log.json")
SETTINGS_FILE = os.path.join(DATA_DIR, "settings.json")
BACKUP_DIR = os.path.join(DATA_DIR, "backups")

# Ensure directories exist
os.makedirs(DATA_DIR, exist_ok=True)
os.makedirs(BACKUP_DIR, exist_ok=True)

# File Operations
def safe_load_json(file_path, default_value):
    try:
        with open(file_path, 'r') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return default_value

def safe_save_json(file_path, data):
    try:
        with open(file_path, 'w') as f:
            json.dump(data, f)
        return True
    except Exception as e:
        st.error(f"Error saving file {file_path}: {str(e)}")
        return False

def load_settings():
    settings = safe_load_json(SETTINGS_FILE, DEFAULT_SETTINGS)
    for key, value in DEFAULT_SETTINGS.items():
        if key not in settings:
            settings[key] = value
        elif isinstance(value, dict):
            for sub_key, sub_value in value.items():
                if sub_key not in settings[key]:
                    settings[key][sub_key] = sub_value
    return settings

def save_settings(new_settings):
    current_settings = load_settings()
    current_settings.update(new_settings)
    return safe_save_json(SETTINGS_FILE, current_settings)

def load_data():
    try:
        return pd.read_csv(DATA_FILE)
    except FileNotFoundError:
        return pd.DataFrame(columns=["‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç", "‡ÆÖ‡Æ≥‡Æµ‡ØÅ", "‡Æ®‡Ææ‡Æ≥‡Øç ‡ÆÖ‡Æ≥‡Æµ‡ØÅ", "‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", 
                                   "‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç", "‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø", 
                                   "‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø", "‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç", "‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà", 
                                   "‡Æµ‡Æï‡Øà", "‡Æµ‡Æø‡Æ≤‡Øà"])
    except Exception as e:
        st.error(f"Error loading medication data: {str(e)}")
        return pd.DataFrame()

def load_history():
    try:
        return pd.read_csv(HISTORY_FILE)
    except FileNotFoundError:
        return pd.DataFrame(columns=["‡Æ§‡Øá‡Æ§‡Æø", "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ", "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç", "‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç"])
    except Exception as e:
        st.error(f"Error loading history data: {str(e)}")
        return pd.DataFrame()

def safe_save_data(df, file_path):
    try:
        df.to_csv(file_path, index=False)
        return True
    except Exception as e:
        st.error(f"Error saving data to {file_path}: {str(e)}")
        return False

def save_data(df):
    return safe_save_data(df, DATA_FILE)

def save_history(df):
    return safe_save_data(df, HISTORY_FILE)

def get_stock_status(stock, times_per_day, cost=0):
    settings = load_settings()
    try:
        stock = float(stock)
        times_per_day = float(times_per_day)
        cost = float(cost)
        
        days_remaining = stock / times_per_day if times_per_day > 0 else 0
        monthly_cost = cost * times_per_day * 30
        
        status_info = {
            "days_remaining": days_remaining,
            "monthly_cost": monthly_cost,
            "status": "‚úÖ",
            "message": f"{days_remaining:.0f} ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ©"
        }
        
        threshold = settings.get("low_stock_threshold", DEFAULT_SETTINGS["low_stock_threshold"])
        
        if days_remaining <= threshold:
            status_info["status"] = "‚ùå"
            status_info["message"] = f"‡Æµ‡ØÜ‡Æ±‡ØÅ‡ÆÆ‡Øç {days_remaining:.0f} ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Øç! ‡Æâ‡Æü‡Æ©‡Øá ‡Æµ‡Ææ‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç!"
        elif days_remaining <= 30:
            status_info["status"] = "‚ö†Ô∏è"
            status_info["message"] = f"{days_remaining:.0f} ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øá ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ©"
        
        return status_info
    except (ValueError, TypeError, ZeroDivisionError) as e:
        return {
            "days_remaining": 0,
            "monthly_cost": 0,
            "status": "‚ùå",
            "message": "‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æ™‡Æø‡Æ¥‡Øà"
        }

def check_and_notify_reminders():
    if not load_settings()["notification_enabled"]:
        return
        
    med_data = load_data()
    reminder_log = safe_load_json(REMINDER_LOG_FILE, {})
    current_time = datetime.now(TIMEZONE)
    
    for _, med in med_data.iterrows():
        if pd.isna(med["‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç"]):
            continue
            
        reminder_times = med["‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç"].split(", ")
        for time_str in reminder_times:
            try:
                reminder_time = datetime.strptime(f"{current_time.date()} {time_str}", 
                                                "%Y-%m-%d %H:%M")
                reminder_time = TIMEZONE.localize(reminder_time)
                
                reminder_key = f"{med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}_{current_time.date()}_{time_str}"
                time_diff = abs((current_time - reminder_time).total_seconds() / 60)
                
                if (time_diff <= load_settings()["reminder_advance_minutes"] and 
                    reminder_key not in reminder_log):
                    notification.notify(
                        title=f"‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç - {med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}",
                        message=f"‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç!\n‡ÆÖ‡Æ≥‡Æµ‡ØÅ: {med['‡ÆÖ‡Æ≥‡Æµ‡ØÅ']}",
                        app_icon=None,
                        timeout=10,
                    )
                    
                    reminder_log[reminder_key] = {
                        "timestamp": current_time.strftime("%Y-%m-%d %H:%M:%S"),
                        "status": "notified"
                    }
                    safe_save_json(REMINDER_LOG_FILE, reminder_log)
                    
                    history_df = load_history()
                    new_history = pd.DataFrame([{
                        "‡Æ§‡Øá‡Æ§‡Æø": current_time.strftime("%Y-%m-%d %H:%M:%S"),
                        "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ": med["‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç"],
                        "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç": "‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç",
                        "‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç": f"‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç: {time_str}"
                    }])
                    history_df = pd.concat([history_df, new_history], ignore_index=True)
                    save_history(history_df)
            except Exception as e:
                st.error(f"Reminder error for {med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}: {str(e)}")

def create_backup():
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_folder = os.path.join(BACKUP_DIR, timestamp)
    os.makedirs(backup_folder, exist_ok=True)
    
    for file in [DATA_FILE, HISTORY_FILE, REMINDER_LOG_FILE, SETTINGS_FILE]:
        if os.path.exists(file):
            backup_file = os.path.join(backup_folder, os.path.basename(file))
            with open(file, 'rb') as f_src, open(backup_file, 'wb') as f_dst:
                f_dst.write(f_src.read())
    return backup_folder

def generate_qr_code(med_data):
    qr = qrcode.QRCode(version=1, box_size=10, border=5)
    qr.add_data(str(med_data))
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    
    img_byte_arr = io.BytesIO()
    img.save(img_byte_arr, format='PNG')
    return img_byte_arr.getvalue()

def send_email_report(email_settings, report_type, data):
    if not email_settings.get("enabled", False):
        return False
        
    msg = MIMEMultipart()
    msg['From'] = email_settings['email']
    msg['To'] = email_settings['email']
    msg['Subject'] = f"‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà - {report_type}"
    msg.attach(MIMEText(str(data), 'plain'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(email_settings['email'], email_settings['password'])
        server.send_message(msg)
        server.quit()
        return True
    except Exception as e:
        st.error(f"Email error: {str(e)}")
        return False

def main():
    st.set_page_config(page_title="‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Æø", page_icon="üíä", layout="wide")
    
    if 'authenticated' not in st.session_state:
        st.session_state.authenticated = False
    
    st.sidebar.title("üíä ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ")
    
    pages = {
        "üè† ‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ": render_dashboard,
        "‚ûï ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ": render_add_medication,
        "üì¶ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ": render_stock_management,
        "üìù ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ": render_medication_history,
        "üìà ‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æø‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç": render_analytics,
        "‚öôÔ∏è ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç": render_settings
    }
    
    selection = st.sidebar.radio("‡ÆÆ‡ØÜ‡Æ©‡ØÅ", list(pages.keys()))
    
    if st.sidebar.button("‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ"):
        st.session_state.authenticated = False
        st.experimental_rerun()
    
    st.sidebar.markdown("---")
    st.sidebar.markdown("v1.0.0")
    
    try:
        pages[selection]()
    except Exception as e:
        st.error(f"Error in {selection}: {str(e)}")
    
    st.markdown("---")
    st.markdown(
        """
        <div style='text-align: center'>
            üíä ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Æø ¬© 2024
        </div>
        """,
        unsafe_allow_html=True
    )

# Page rendering functions
def render_dashboard():
    st.header("üìä ‡Æü‡Ææ‡Æ∑‡Øç‡Æ™‡Øã‡Æ∞‡Øç‡Æü‡ØÅ")
    med_data = load_data()
    
    if med_data.empty:
        st.info("‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øà ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç")
        return
    
    try:
        # Data preprocessing
        if '‡Æµ‡Æø‡Æ≤‡Øà' not in med_data.columns:
            med_data['‡Æµ‡Æø‡Æ≤‡Øà'] = 0.0
        if '‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø ‡Æ§‡Øá‡Æ§‡Æø' not in med_data.columns:
            med_data['‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø ‡Æ§‡Øá‡Æ§‡Æø'] = None
        if '‡Æµ‡Æï‡Øà' not in med_data.columns:
            med_data['‡Æµ‡Æï‡Øà'] = '‡Æ™‡Øä‡Æ§‡ØÅ'
            
        med_data['‡Æµ‡Æø‡Æ≤‡Øà'] = med_data['‡Æµ‡Æø‡Æ≤‡Øà'].fillna(0).astype(float)
        
        # Main metrics
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç", len(med_data))
        with col2:
            st.metric("‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", med_data["‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ"].sum())
        with col3:
            low_stock = len(med_data[med_data.apply(
                lambda x: get_stock_status(x["‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ"], 
                                         x["‡Æ®‡Ææ‡Æ≥‡Øç ‡ÆÖ‡Æ≥‡Æµ‡ØÅ"])["status"] == "‚ùå", axis=1)])
            st.metric("‡Æï‡ØÅ‡Æ±‡Øà‡Æ®‡Øç‡Æ§ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", f"{low_stock} ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç")
        with col4:
            total_value = (med_data['‡Æµ‡Æø‡Æ≤‡Øà'] * med_data['‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']).sum()
            st.metric("‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ", f"‚Çπ{total_value:,.2f}")
            
        st.subheader("üìã ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç")
        if not med_data.empty:
            st.dataframe(med_data)

        # Expiry Alerts
        st.subheader("‚ö†Ô∏è ‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç")
        if '‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø ‡Æ§‡Øá‡Æ§‡Æø' in med_data.columns:
            today = pd.Timestamp.now()
            expiring_soon = med_data[pd.to_datetime(med_data['‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø ‡Æ§‡Øá‡Æ§‡Æø']) - today <= pd.Timedelta(days=30)]
            if not expiring_soon.empty:
                st.warning(f"{len(expiring_soon)} ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§ 30 ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Æø‡Æ≤‡Øç ‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø‡ÆØ‡Ææ‡Æï‡Æø‡Æ©‡Øç‡Æ±‡Æ©")
                st.dataframe(expiring_soon[['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç', '‡Æï‡Ææ‡Æ≤‡Ææ‡Æµ‡Æ§‡Æø ‡Æ§‡Øá‡Æ§‡Æø', '‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']])

        # Category Analysis
        st.subheader("üìä ‡Æµ‡Æï‡Øà ‡Æµ‡Ææ‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ")
        if '‡Æµ‡Æï‡Øà' in med_data.columns:
            cat_data = med_data.groupby('‡Æµ‡Æï‡Øà').agg({
                '‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç': 'count',
                '‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ': 'sum',
                '‡Æµ‡Æø‡Æ≤‡Øà': lambda x: (x * med_data.loc[x.index, '‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']).sum()
            }).reset_index()
            cat_data.columns = ['‡Æµ‡Æï‡Øà', '‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç', '‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ', '‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ']
            st.dataframe(cat_data)

        # Stock Level Visualization
        st.subheader("üìà ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ®‡Æø‡Æ≤‡Øà")
        stock_fig = px.bar(med_data.nlargest(10, '‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ'),
                          x='‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç', y='‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ',
                          title='‡ÆÖ‡Æ§‡Æø‡Æï ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æâ‡Æ≥‡Øç‡Æ≥ 10 ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç')
        st.plotly_chart(stock_fig)

        # Value Analysis
        st.subheader("üí∞ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ")
        med_data['‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ'] = med_data['‡Æµ‡Æø‡Æ≤‡Øà'] * med_data['‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']
        value_fig = px.pie(med_data.nlargest(5, '‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ'),
                          values='‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ',
                          names='‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç',
                          title='‡ÆÖ‡Æ§‡Æø‡Æï ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥ 5 ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç')
        st.plotly_chart(value_fig)

    except Exception as e:
        st.error(f"‡Æü‡Ææ‡Æ∑‡Øç‡Æ™‡Øã‡Æ∞‡Øç‡Æü‡ØÅ ‡Æ™‡Æø‡Æ¥‡Øà: {str(e)}")
def render_add_medication():
    st.header("‚ûï ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ∞‡Øç‡Æµ‡Æï‡Æø")
    
    # Add Medication Form
    with st.form("add_med_form"):
        st.subheader("‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç")
        col1, col2 = st.columns(2)
        with col1:
            name = st.text_input("‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç")
            dosage = st.text_input("‡ÆÖ‡Æ≥‡Æµ‡ØÅ")
            category = st.selectbox("‡Æµ‡Æï‡Øà", ["‡ÆÆ‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà‡Æï‡Æ≥‡Øç", "‡Æ§‡Æø‡Æ∞‡Æµ‡ÆÆ‡Øç", "‡Æä‡Æö‡Æø", "‡ÆÆ‡Æ±‡Øç‡Æ±‡Æµ‡Øà"])
            priority = st.selectbox("‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà", ["‡Æâ‡ÆØ‡Æ∞‡Øç", "‡Æ®‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ∞‡ÆÆ‡Øç", "‡Æï‡ØÅ‡Æ±‡Øà‡Æ®‡Øç‡Æ§"])
            price = st.number_input("‡Æµ‡Æø‡Æ≤‡Øà", min_value=0.0, step=0.01)
        with col2:
            times_per_day = st.number_input("‡Æ®‡Ææ‡Æ≥‡Øç ‡ÆÖ‡Æ≥‡Æµ‡ØÅ", min_value=1)
            stock = st.number_input("‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", min_value=0)
            start_date = st.date_input("‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø")
            end_date = st.date_input("‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø")
            reminder_times = st.multiselect(
                "‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç",
                ["06:00", "07:00", "08:00", "09:00", "12:00", "13:00", 
                 "14:00", "15:00", "18:00", "19:00", "20:00", "21:00", "22:00"],
                default=[]
            )
        
        notes = st.text_area("‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç")
        submitted = st.form_submit_button("‡Æö‡Øá‡ÆÆ‡Æø")
        
        if submitted and name and dosage:
            try:
                med_data = load_data()
                new_med = {
                    "‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç": name,
                    "‡ÆÖ‡Æ≥‡Æµ‡ØÅ": dosage,
                    "‡Æ®‡Ææ‡Æ≥‡Øç ‡ÆÖ‡Æ≥‡Æµ‡ØÅ": times_per_day,
                    "‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ": stock,
                    "‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç": ", ".join(reminder_times),
                    "‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø": start_date.strftime("%Y-%m-%d"),
                    "‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø": end_date.strftime("%Y-%m-%d"),
                    "‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç": notes,
                    "‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà": priority,
                    "‡Æµ‡Æï‡Øà": category,
                    "‡Æµ‡Æø‡Æ≤‡Øà": price
                }
                med_data = pd.concat([med_data, pd.DataFrame([new_med])], ignore_index=True)
                if save_data(med_data):
                    st.success("‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!")
                    
                    # Add to history
                    history_df = load_history()
                    new_history = pd.DataFrame([{
                        "‡Æ§‡Øá‡Æ§‡Æø": datetime.now(TIMEZONE).strftime("%Y-%m-%d %H:%M:%S"),
                        "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ": name,
                        "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç": "‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ",
                        "‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç": f"‡ÆÖ‡Æ≥‡Æµ‡ØÅ: {dosage}, ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ: {stock}"
                    }])
                    history_df = pd.concat([history_df, new_history], ignore_index=True)
                    save_history(history_df)
            except Exception as e:
                st.error(f"‡Æ™‡Æø‡Æ¥‡Øà ‡Æè‡Æ±‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ: {str(e)}")
                history_df = load_history()
                new_history = pd.DataFrame([{
                    "‡Æ§‡Øá‡Æ§‡Æø": datetime.now(TIMEZONE).strftime("%Y-%m-%d %H:%M:%S"),
                    "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ": name,
                    "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç": "‡Æ™‡Æø‡Æ¥‡Øà",
                    "‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç": str(e)
                }])
                history_df = pd.concat([history_df, new_history], ignore_index=True)
                save_history(history_df)

    # View Medications
    st.subheader("üìã ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç")
    try:
        med_data = load_data()
        if not med_data.empty:
            for index, row in med_data.iterrows():
                with st.expander(f"{row['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']} - {row['‡Æµ‡Æï‡Øà']}"):
                    st.write(f"**‡ÆÖ‡Æ≥‡Æµ‡ØÅ:** {row['‡ÆÖ‡Æ≥‡Æµ‡ØÅ']}")
                    st.write(f"**‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ:** {row['‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']}")
                    st.write(f"**‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç:** {row['‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç']}")
                    st.write(f"**‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà:** {row['‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà']}")
                    st.write(f"**‡Æµ‡Æø‡Æ≤‡Øà:** ‚Çπ{row['‡Æµ‡Æø‡Æ≤‡Øà']}")
                    st.write(f"**‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø:** {row['‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø']}")
                    st.write(f"**‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø:** {row['‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø']}")
                    st.write(f"**‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç:** {row['‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç']}")

                    # Update Medication
                    if st.button(f"‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï {row['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}", key=f"update_{index}"):
                        st.warning("‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÖ‡ÆÆ‡Øç‡Æö‡ÆÆ‡Øç ‡Æµ‡Æø‡Æ∞‡Øà‡Æµ‡Æø‡Æ≤‡Øç!")
                    
                    # Delete Medication
                    if st.button(f"‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï {row['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}", key=f"delete_{index}"):
                        med_data = med_data.drop(index)
                        save_data(med_data)
                        st.success(f"'{row['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}' ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!")
        else:
            st.info("‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà!")
    except Exception as e:
        st.error(f"‡Æ™‡Æø‡Æ¥‡Øà ‡Æè‡Æ±‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ: {str(e)}")

                    
def check_and_notify_reminders():
    if not load_settings()["notification_enabled"]:
        return
        
    med_data = load_data()
    reminder_log = safe_load_json(REMINDER_LOG_FILE, {})
    current_time = datetime.now(TIMEZONE)
    
    for _, med in med_data.iterrows():
        if pd.isna(med["‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç"]) or not med["‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç"]:
            continue
            
        reminder_times = med["‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç"].split(", ")
        for time_str in reminder_times:
            try:
                reminder_time = datetime.strptime(f"{current_time.date()} {time_str}", 
                                                "%Y-%m-%d %H:%M")
                reminder_time = TIMEZONE.localize(reminder_time)
                
                reminder_key = f"{med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}_{current_time.date()}_{time_str}"
                time_diff = abs((current_time - reminder_time).total_seconds() / 60)
                
                if (time_diff <= load_settings()["reminder_advance_minutes"] and 
                    reminder_key not in reminder_log):
                    notification.notify(
                        title=f"‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç - {med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}",
                        message=f"‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç!\n‡ÆÖ‡Æ≥‡Æµ‡ØÅ: {med['‡ÆÖ‡Æ≥‡Æµ‡ØÅ']}\n‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç: {time_str}",
                        app_icon=None,
                        timeout=10,
                    )
                    
                    # Play alarm sound
                    try:
                        import winsound
                        winsound.Beep(1000, 1000)  # frequency=1000Hz, duration=1000ms
                    except:
                        pass
                    
                    reminder_log[reminder_key] = {
                        "timestamp": current_time.strftime("%Y-%m-%d %H:%M:%S"),
                        "status": "notified"
                    }
                    safe_save_json(REMINDER_LOG_FILE, reminder_log)
            except Exception as e:
                st.error(f"Reminder error for {med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}: {str(e)}")

def render_stock_management():
    st.header("üì¶ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÆ‡Øá‡Æ≤‡Ææ‡Æ£‡Øç‡ÆÆ‡Øà")
    med_data = load_data()
    
    if med_data.empty:
        st.info("‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà")
        return
    
    for _, med in med_data.iterrows():
        with st.expander(f"{med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']} - ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ: {med['‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']}"):
            col1, col2 = st.columns(2)
            with col1:
                new_stock = st.number_input(
                    "‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ",
                    min_value=0,
                    value=int(med['‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']),
                    key=f"stock_{med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}"
                )
            with col2:
                action = st.selectbox(
                    "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç",
                    ["‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø", "‡Æï‡Æ¥‡Æø", "‡Æö‡Øá‡Æ∞‡Øç"],
                    key=f"action_{med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}"
                )
            
            if st.button("‡Æö‡Øá‡ÆÆ‡Æø", key=f"save_{med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç']}"):
                try:
                    old_stock = med['‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ']
                    med_data.loc[med_data['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç'] == med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç'], '‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ'] = new_stock
                    
                    if save_data(med_data):
                        st.success("‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!")
                        
                        history_df = load_history()
                        new_history = pd.DataFrame([{
                            "‡Æ§‡Øá‡Æ§‡Æø": datetime.now(TIMEZONE).strftime("%Y-%m-%d %H:%M:%S"),
                            "‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ": med['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç'],
                            "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç": action,
                            "‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç": f"‡Æ™‡Æ¥‡Øà‡ÆØ: {old_stock}, ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ: {new_stock}"
                        }])
                        history_df = pd.concat([history_df, new_history], ignore_index=True)
                        save_history(history_df)
                except Exception as e:
                    st.error(f"‡Æ™‡Æø‡Æ¥‡Øà: {str(e)}")

def render_medication_history():
    st.header("üìù ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ")
    history_df = load_history()
    
    if history_df.empty:
        st.info("‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà")
        return
    
    col1, col2 = st.columns(2)
    with col1:
        start_date = st.date_input("‡Æ§‡Øä‡Æü‡Æï‡Øç‡Æï ‡Æ§‡Øá‡Æ§‡Æø", 
                                  value=datetime.now().date() - timedelta(days=7))
    with col2:
        end_date = st.date_input("‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø", 
                                value=datetime.now().date())
    
    filtered_history = history_df[
        (pd.to_datetime(history_df['‡Æ§‡Øá‡Æ§‡Æø']).dt.date >= start_date) &
        (pd.to_datetime(history_df['‡Æ§‡Øá‡Æ§‡Æø']).dt.date <= end_date)
    ]
    
    st.dataframe(filtered_history.sort_values('‡Æ§‡Øá‡Æ§‡Æø', ascending=False))

def render_analytics():
    st.header("üìà ‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æø‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç")
    med_data = load_data()
    history_df = load_history()
    
    if med_data.empty or history_df.empty:
        st.info("‡Æ™‡Øã‡Æ§‡ØÅ‡ÆÆ‡Ææ‡Æ© ‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà")
        return
    
    # Stock levels visualization
    st.subheader("‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ®‡Æø‡Æ≤‡Øà")
    fig = px.bar(med_data, x="‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç", y="‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", 
                 color="‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡ØÅ‡Æ∞‡Æø‡ÆÆ‡Øà", title="‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ")
    st.plotly_chart(fig)
    
    # Usage trends
    st.subheader("‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Ææ‡Æü‡Øç‡Æü‡ØÅ ‡Æ™‡Øã‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç")
    usage_data = history_df[history_df['‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç'] == '‡Æï‡Æ¥‡Æø'].groupby(
        pd.to_datetime(history_df['‡Æ§‡Øá‡Æ§‡Æø']).dt.date
    ).size().reset_index()
    usage_data.columns = ['‡Æ§‡Øá‡Æ§‡Æø', '‡Æé‡Æ£‡Øç‡Æ£‡Æø‡Æï‡Øç‡Æï‡Øà']
    
    fig = px.line(usage_data, x='‡Æ§‡Øá‡Æ§‡Æø', y='‡Æé‡Æ£‡Øç‡Æ£‡Æø‡Æï‡Øç‡Æï‡Øà', 
                  title="‡Æ§‡Æø‡Æ©‡Æö‡Æ∞‡Æø ‡ÆÆ‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Ææ‡Æü‡ØÅ")
    st.plotly_chart(fig)

def render_settings():
    st.header("‚öôÔ∏è ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç")
    settings = load_settings()
    
    with st.form("settings_form"):
        notification_enabled = st.checkbox("‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øç", 
                                         value=settings["notification_enabled"])
        low_stock_threshold = st.number_input("‡Æï‡ØÅ‡Æ±‡Øà‡Æ®‡Øç‡Æ§ ‡Æï‡Øà‡ÆØ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æé‡Æ≤‡Øç‡Æ≤‡Øà", 
                                            value=settings["low_stock_threshold"])
        reminder_advance = st.number_input("‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æ©‡Øç ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç (‡Æ®‡Æø‡ÆÆ‡Æø‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç)", 
                                         value=settings["reminder_advance_minutes"])
        
        email_settings = settings["email_settings"]
        st.subheader("‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç")
        email_enabled = st.checkbox("‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç", 
                                  value=email_settings["enabled"])
        email = st.text_input("‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç", value=email_settings["email"])
        password = st.text_input("‡Æï‡Æü‡Æµ‡ØÅ‡Æö‡Øç‡Æö‡Øä‡Æ≤‡Øç", type="password", 
                               value=email_settings["password"])
        
        if st.form_submit_button("‡Æö‡Øá‡ÆÆ‡Æø"):
            new_settings = {
                "notification_enabled": notification_enabled,
                "low_stock_threshold": low_stock_threshold,
                "reminder_advance_minutes": reminder_advance,
                "email_settings": {
                    "enabled": email_enabled,
                    "email": email,
                    "password": password
                }
            }
            if save_settings(new_settings):
                st.success("‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©!")

if __name__ == "__main__":
    main()